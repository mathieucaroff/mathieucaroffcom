---
import Layout from "../layouts/Layout.astro"
import ProjectCard from "../components/ProjectCard.astro"
import { fetchGitHubProjects } from "../lib/github"

const githubToken = import.meta.env.GITHUB_TOKEN
let projects = await fetchGitHubProjects("mathieucaroff", githubToken)
---

<Layout title="Mathieu CAROFF's">
  <main class="mx-auto w-full max-w-[1200px] min-w-0">
    <header
      class="mb-8 flex min-w-0 flex-col items-start gap-4 rounded-lg border-2 border-[rgba(150,150,150,0.3)] bg-[rgba(255,255,255,0.85)] p-4 backdrop-blur-[15px] md:flex-row md:items-center"
    >
      <div class="logo shrink-0">
        <a href="/"
          ><img
            src="/redarrow420.png"
            class="max-h-[140px] h-auto max-w-full"
        /></a>
      </div>

      <div class="header-content w-full min-w-0 md:w-auto">
        <h1 class="mb-2 break-words text-[2rem] md:text-[2.5rem]">
          mathieucaroff.com
        </h1>

        <div class="socials mt-4">
          <h4 class="mb-2 text-[1.1rem]">Socials</h4>
          <p class="brandiconheader flex flex-wrap gap-4 text-[1.75rem] md:text-[2rem]">
            <a
              href="https://github.com/mathieucaroff"
              title="github"
              class="text-neutral-800 transition-colors hover:text-[#0066cc] hover:no-underline"
              ><i class="fa fa-github"></i></a
            >
            <a
              href="https://gitlab.com/caroff"
              title="gitlab"
              class="text-neutral-800 transition-colors hover:text-[#0066cc] hover:no-underline"
              ><i class="fa fa-gitlab"></i></a
            >
            <a
              href="https://www.reddit.com/u/mathieucaroff/"
              title="reddit"
              class="text-neutral-800 transition-colors hover:text-[#0066cc] hover:no-underline"
              ><i class="fa fa-reddit"></i></a
            >
            <a
              href="https://www.linkedin.com/in/mathieu-caroff/"
              title="linkedin"
              class="text-neutral-800 transition-colors hover:text-[#0066cc] hover:no-underline"
              ><i class="fa fa-linkedin"></i></a
            >
            <a
              href="https://stackoverflow.com/u/9878263"
              title="stackoverflow"
              class="text-neutral-800 transition-colors hover:text-[#0066cc] hover:no-underline"
              ><i class="fa fa-stack-overflow"></i></a
            >
          </p>
        </div>
      </div>

      <aside class="header-right self-start md:ml-auto">
        <a href="/madelaine">La Madelaine</a>
      </aside>
    </header>

    <section
      class="useful-links mb-8 rounded-lg border-2 border-[rgba(150,150,150,0.3)] bg-[rgba(255,255,255,0.85)] p-4 backdrop-blur-[15px]"
    >
      <h2 class="mb-4 text-[1.5rem]">Useful Links</h2>
      <ul
        class="externallinklist grid list-none grid-flow-col grid-rows-[repeat(90,auto)] sm:grid-rows-[repeat(7,auto)] md:grid-rows-[repeat(5,auto)] lg:grid-rows-[repeat(4,auto)] xl:grid-rows-[repeat(3,auto)]"
      >
        <!-- note: the <b></b> are there for the CSS `.externallinklist b:after { content: "\f08e"; }` to work -->
        <li>
          <a href="https://regex101.com/" class="external-link"
            ><span>üî§</span>Regex test tool<b></b></a
          >
        </li>
        <li>
          <a href="https://dbfiddle.uk/" class="external-link"
            ><span>üî§</span>SQL snippet testing and sharing<b></b></a
          >
        </li>
        <li>
          <a href="https://unicode-table.com/" class="external-link"
            ><span>üîç</span>Unicode search tool<b></b></a
          >
        </li>
        <li>
          <a href="https://fontawesome.com/v4/icons/" class="external-link"
            ><span><i class="fa fa-flag"></i></span>Font Awesome<b></b></a
          >
        </li>
        <li>
          <a
            href="https://react-icons.github.io/react-icons/icons"
            class="external-link"><span>"</span>React icons<b></b></a
          >
        </li>
        <li>
          <a href="https://detexify.kirelabs.org/" class="external-link"
            ><span>‚à´</span>LaTeX symbol search tool<b></b></a
          >
        </li>
        <li>
          <a href="https://gchq.github.io/CyberChef" class="external-link"
            ><span>üç≤</span>CyberChef (sort, case change...)<b></b></a
          >
        </li>
        <li>
          <a href="https://omrelli.ug/nearley-playground/" class="external-link"
            ><span>üìï</span>Grammar tool<b></b></a
          >
        </li>
        <li>
          <a href="https://ifconfig.me/" class="external-link"
            ><span>üåê</span>IP Address<b></b></a
          >
        </li>
        <!-- curl ifconfig.me; curl ipinfo.io -->
        <li>
          <a
            href="https://en.wikipedia.org/wiki/Country_code_top-level_domain"
            class="external-link"><span>.</span>Country TLDs<b></b></a
          >
        </li>
        <li>
          <a
            href="https://en.wikipedia.org/wiki/List_of_Internet_top-level_domains"
            class="external-link"><span>..</span>Other TLDs<b></b></a
          >
        </li>
        <li>
          <a href="https://excalidraw.com/" class="external-link"
            ><span>‚úé</span>Excalidraw<b></b></a
          >
        </li>
        <li>
          <a href="https://app.diagrams.net/" class="external-link"
            ><span>üõÜ</span>Draw.io<b></b></a
          >
        </li>
        <li>
          <a href="https://www.planttext.com/" class="external-link"
            ><span>‚ñ°‚ñ°</span>PlantText<b></b></a
          >
        </li>
      </ul>
    </section>

    <h2 class="mb-4 text-[1.5rem]">My GitHub Projects</h2>
    <section
      class="controls mb-8 flex flex-col items-start gap-4 rounded-lg border-2 border-[rgba(150,150,150,0.3)] bg-[rgba(245,245,245,0.85)] p-4 backdrop-blur-[15px] md:flex-row md:flex-wrap"
    >
      <div class="search-filter min-w-[250px] flex-1">
        <div class="search-input-wrapper relative flex items-center">
          <input
            type="text"
            id="searchInput"
            placeholder="Search projects by title, description, topics, or languages..."
            autocomplete="off"
            class="w-full rounded border border-[#ccc] bg-white p-3 pr-10 text-base focus:border-[#0066cc] focus:outline-none"
          />
          <button
            id="clearSearch"
            class="clear-search absolute right-2 flex hidden h-6 w-6 cursor-pointer items-center justify-center rounded-full border-0 bg-none p-0 text-[1.5rem] text-neutral-400 transition-all hover:bg-black/10 hover:text-neutral-800"
            title="Clear search"
            type="button"
            aria-label="Clear search"
          >
            <span class="block translate-y-[-0.06em]">√ó</span>
          </button>
        </div>
        <div class="keyword-chips mt-2 flex flex-wrap gap-2">
          <button
            class="keyword-chip cursor-pointer rounded-full border-0 px-3 py-2 text-sm font-medium transition-all hover:-translate-y-0.5 hover:shadow-[0_2px_8px_rgba(0,0,0,0.15)] active:translate-y-0 data-[keyword=featured]:bg-[#ffd700] data-[keyword=featured]:text-neutral-800 data-[keyword=game]:bg-[#ff6b9d] data-[keyword=game]:text-white data-[keyword=keyboard]:bg-[#ff9f43] data-[keyword=keyboard]:text-white data-[keyword=tool]:bg-[#6c5ce7] data-[keyword=tool]:text-white"
            data-keyword="featured"
            type="button"
          >
            featured
          </button>
          <button
            class="keyword-chip cursor-pointer rounded-full border-0 px-3 py-2 text-sm font-medium transition-all hover:-translate-y-0.5 hover:shadow-[0_2px_8px_rgba(0,0,0,0.15)] active:translate-y-0 data-[keyword=featured]:bg-[#ffd700] data-[keyword=featured]:text-neutral-800 data-[keyword=game]:bg-[#ff6b9d] data-[keyword=game]:text-white data-[keyword=keyboard]:bg-[#ff9f43] data-[keyword=keyboard]:text-white data-[keyword=tool]:bg-[#6c5ce7] data-[keyword=tool]:text-white"
            data-keyword="game"
            type="button"
          >
            game
          </button>
          <button
            class="keyword-chip cursor-pointer rounded-full border-0 px-3 py-2 text-sm font-medium transition-all hover:-translate-y-0.5 hover:shadow-[0_2px_8px_rgba(0,0,0,0.15)] active:translate-y-0 data-[keyword=featured]:bg-[#ffd700] data-[keyword=featured]:text-neutral-800 data-[keyword=game]:bg-[#ff6b9d] data-[keyword=game]:text-white data-[keyword=keyboard]:bg-[#ff9f43] data-[keyword=keyboard]:text-white data-[keyword=tool]:bg-[#6c5ce7] data-[keyword=tool]:text-white"
            data-keyword="tool"
            type="button"
          >
            tool
          </button>
          <button
            class="keyword-chip cursor-pointer rounded-full border-0 px-3 py-2 text-sm font-medium transition-all hover:-translate-y-0.5 hover:shadow-[0_2px_8px_rgba(0,0,0,0.15)] active:translate-y-0 data-[keyword=featured]:bg-[#ffd700] data-[keyword=featured]:text-neutral-800 data-[keyword=game]:bg-[#ff6b9d] data-[keyword=game]:text-white data-[keyword=keyboard]:bg-[#ff9f43] data-[keyword=keyboard]:text-white data-[keyword=tool]:bg-[#6c5ce7] data-[keyword=tool]:text-white"
            data-keyword="keyboard"
            type="button"
          >
            keyboard
          </button>
        </div>
      </div>

      <div
        class="sort-controls flex flex-col gap-2 md:flex-row md:items-center"
      >
        <label for="sortSelect">Sort by:</label>
        <select
          id="sortSelect"
          class="cursor-pointer rounded border border-[#ccc] bg-white p-3 text-base"
        >
          <option value="updated-desc">Last Updated (Newest)</option>
          <option value="updated-asc">Last Updated (Oldest)</option>
          <option value="created-desc">Created (Newest)</option>
          <option value="created-asc">Created (Oldest)</option>
        </select>
      </div>

      <div
        class="archive-filter flex flex-col gap-2 md:flex-row md:items-center"
      >
        <label for="archiveSelect">Archived:</label>
        <select
          id="archiveSelect"
          class="cursor-pointer rounded border border-[#ccc] bg-white p-3 text-base"
        >
          <option value="hide">Hide archived</option>
          <option value="show">Show all</option>
          <option value="only">Only archived</option>
        </select>
      </div>

      <div class="demo-filter flex w-full items-center">
        <label class="flex cursor-pointer items-center gap-2 text-base">
          <input
            type="checkbox"
            id="onlineOnlyCheckbox"
            class="h-5 w-5 cursor-pointer"
          />
          Only projects which can be run or tested online
        </label>
      </div>

      <div class="stats font-medium text-neutral-500">
        <span id="projectCount">{projects.length}</span> projects
      </div>
    </section>

    <div id="projectsContainer" class="flex min-h-[200px] flex-col">
      {
        projects.length === 0 ? (
          <p class="p-8 text-center text-neutral-500">
            No projects found. Check the console for errors.
          </p>
        ) : (
          projects.map((project) => <ProjectCard project={project} />)
        )
      }
    </div>
  </main>
</Layout>

<script>
  import type { Project } from "../lib/github"

  // Get all projects data from the DOM
  const projectsData: Project[] = []
  const projectElements = document.querySelectorAll(".project")

  projectElements.forEach((el) => {
    const article = el as HTMLElement
    const id = parseInt(article.id.replace("project-", ""))
    const title = article.querySelector("h3")?.textContent || ""
    const isArchived = title.includes("Archived")
    const cleanTitle = title.replace("Archived", "").trim()
    const description = article.querySelector(".description")?.textContent || ""
    const repoUrl =
      (article.querySelector('a[href*="github.com"]') as HTMLAnchorElement)
        ?.href || ""
    const demoLink = article.querySelector(
      'a[href]:not([href*="github.com"])'
    ) as HTMLAnchorElement
    const demoUrl = demoLink?.href || null

    const languagesDiv = article.querySelector(".languages")
    const languages = languagesDiv
      ? Array.from(languagesDiv.querySelectorAll(".language")).map(
          (el) => el.textContent?.trim().replace(",", "") || ""
        )
      : []

    const topicsDiv = article.querySelector(".topics")
    const topics = topicsDiv
      ? Array.from(topicsDiv.querySelectorAll(".topic")).map(
          (el) => el.textContent?.trim() || ""
        )
      : []

    const dates = article.querySelectorAll(".dates span")
    const createdText =
      dates[0]?.textContent?.replace("Created:", "").trim() || ""
    const updatedText =
      dates[1]?.textContent?.replace("Updated:", "").trim() || ""

    projectsData.push({
      id,
      title: cleanTitle,
      description,
      repoUrl,
      demoUrl,
      createdAt: new Date(createdText),
      updatedAt: new Date(updatedText),
      topics,
      languages,
      imageUrl: null,
      archived: isArchived,
    })
  })

  const searchInput = document.getElementById("searchInput") as HTMLInputElement
  const sortSelect = document.getElementById("sortSelect") as HTMLSelectElement
  const archiveSelect = document.getElementById(
    "archiveSelect"
  ) as HTMLSelectElement
  const onlineOnlyCheckbox = document.getElementById(
    "onlineOnlyCheckbox"
  ) as HTMLInputElement
  const projectCount = document.getElementById(
    "projectCount"
  ) as HTMLSpanElement
  const projectsContainer = document.getElementById(
    "projectsContainer"
  ) as HTMLDivElement

  let currentProjects = [...projectsData]

  // Fuzzy match function - checks if pattern characters appear in order with limited gaps
  function fuzzyMatch(pattern: string, text: string): boolean {
    pattern = pattern.toLowerCase()
    text = text.toLowerCase()

    const maxGap = 4

    // Try starting the match from each position in the text
    for (let start = 0; start < text.length; start++) {
      let patternIdx = 0
      let lastMatchIdx = -1

      for (let i = start; i < text.length && patternIdx < pattern.length; i++) {
        if (pattern[patternIdx] === text[i]) {
          // Check if gap from last match is within limit
          if (lastMatchIdx !== -1 && i - lastMatchIdx - 1 > maxGap) {
            break // This starting position doesn't work, try next
          }
          lastMatchIdx = i
          patternIdx++
        }
      }

      if (patternIdx === pattern.length) {
        return true // Found a complete match
      }
    }

    return false // No complete match found from any starting position
  }

  function filterProjects(
    searchTerm: string,
    onlineOnly: boolean,
    archiveFilter: string
  ) {
    const terms = searchTerm
      .toLowerCase()
      .split(/\s+/)
      .filter((t) => t.length > 0)

    return projectsData.filter((project) => {
      // All search terms must match (with fuzzy matching)
      const matchesSearch = terms.every((term) => {
        return (
          fuzzyMatch(term, project.title) ||
          fuzzyMatch(term, project.description) ||
          project.topics.some((topic) => fuzzyMatch(term, topic)) ||
          project.languages.some((lang) => fuzzyMatch(term, lang))
        )
      })

      const matchesDemo = !onlineOnly || project.demoUrl !== null

      let matchesArchive = true
      if (archiveFilter === "hide") {
        matchesArchive = !project.archived
      } else if (archiveFilter === "only") {
        matchesArchive = project.archived
      }
      // "show" means show all, so no filtering

      return matchesSearch && matchesDemo && matchesArchive
    })
  }

  function sortProjects(projects: Project[], sortBy: string) {
    const sorted = [...projects]

    switch (sortBy) {
      case "updated-desc":
        sorted.sort((a, b) => b.updatedAt.getTime() - a.updatedAt.getTime())
        break
      case "updated-asc":
        sorted.sort((a, b) => a.updatedAt.getTime() - b.updatedAt.getTime())
        break
      case "created-desc":
        sorted.sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime())
        break
      case "created-asc":
        sorted.sort((a, b) => a.createdAt.getTime() - b.createdAt.getTime())
        break
    }

    return sorted
  }

  function updateDisplay() {
    const searchTerm = searchInput.value
    const sortBy = sortSelect.value
    const archiveFilter = archiveSelect.value
    const onlineOnly = onlineOnlyCheckbox.checked

    let filtered = filterProjects(searchTerm, onlineOnly, archiveFilter)
    currentProjects = sortProjects(filtered, sortBy)

    // Update count
    projectCount.textContent = currentProjects.length.toString()

    // Hide all projects first
    projectElements.forEach((el) => {
      ;(el as HTMLElement).style.display = "none"
    })

    // Show and reorder filtered projects
    currentProjects.forEach((project, index) => {
      const element = document.getElementById(`project-${project.id}`)
      if (element) {
        element.style.display = "block"
        element.style.order = index.toString()
      }
    })
  }

  // Clear search button
  const clearSearchBtn = document.getElementById(
    "clearSearch"
  ) as HTMLButtonElement

  function updateClearButton() {
    if (searchInput.value.length > 0) {
      clearSearchBtn.classList.remove("hidden")
    } else {
      clearSearchBtn.classList.add("hidden")
    }
  }

  clearSearchBtn.addEventListener("click", () => {
    searchInput.value = ""
    updateDisplay()
    updateClearButton()
    searchInput.focus()
  })

  // Event listeners
  searchInput.addEventListener("input", () => {
    updateDisplay()
    updateClearButton()
  })
  sortSelect.addEventListener("change", updateDisplay)
  archiveSelect.addEventListener("change", updateDisplay)
  onlineOnlyCheckbox.addEventListener("change", updateDisplay)

  // Initialize clear button state
  updateClearButton()

  // Keyword chip click handlers
  const keywordChips = document.querySelectorAll(".keyword-chip")
  keywordChips.forEach((chip) => {
    chip.addEventListener("click", () => {
      const keyword = (chip as HTMLElement).dataset.keyword || ""
      const currentValue = searchInput.value

      // Remove all keyword instances from search
      const keywords = ["featured", "game", "tool", "keyboard"]
      let newValue = currentValue
      keywords.forEach((kw) => {
        newValue = newValue.replace(new RegExp(`\\b${kw}\\b`, "gi"), "")
      })

      // Clean up extra spaces
      newValue = newValue.replace(/\s+/g, " ").trim()

      // Add the clicked keyword
      searchInput.value = newValue ? `${newValue} ${keyword}` : keyword

      // Trigger search
      updateDisplay()
      updateClearButton()
    })
  })

  // Handle hash navigation
  if (window.location.hash) {
    const target = document.querySelector(window.location.hash)
    if (target) {
      setTimeout(() => {
        target.scrollIntoView({ behavior: "smooth", block: "center" })
      }, 50)
    }
  }

  // Initialize with default sort (already sorted by updated desc from API)
  updateDisplay()
</script>

<style>
  .externallinklist a {
    display: flex;
    align-items: center;
    border-radius: 0.25rem;
    transition: background-color 0.2s;  
  }

  .externallinklist a:hover {
    background-color: rgba(0, 102, 204, 0.1);
  }

  .externallinklist span {
    width: 1.5rem;
  }

  .externallinklist b:after {
    content: "\f08e";
    font-family: FontAwesome;
    margin-left: 0.3rem;
    font-size: 0.85em;
    opacity: 0.6;
  }
</style>
